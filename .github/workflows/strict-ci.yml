name: Strict CI - Quality Gate

on:
  push:
    branches: [ "master", "stable" ]
  pull_request:
    branches: [ "master", "stable" ]

# Cancel previous runs if new commit is pushed
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ============================================================================
  # STEP 1: Kotlin Compilation Check
  # ============================================================================
  kotlin-compile-check:
    name: "Kotlin Compilation"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Clean build
        run: ./gradlew clean

      - name: Compile Kotlin (strict mode)
        run: ./gradlew compileDebugKotlin compileDebugJavaWithJavac --no-daemon --stacktrace
        env:
          ORG_GRADLE_PROJECT_kotlin.caching.enabled: false

      - name: Upload compilation report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: kotlin-compile-report
          path: |
            **/build/reports/
            **/build/outputs/

  # ============================================================================
  # STEP 2: Strict Lint Check
  # ============================================================================
  lint-strict:
    name: "Strict Lint"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: kotlin-compile-check
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Run Lint (fail on any warning)
        run: ./gradlew lintDebug --no-daemon --stacktrace
        env:
          _JAVA_OPTIONS: "-Xmx4g"

      - name: Upload lint report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-report
          path: |
            **/build/reports/lint-results-*.html
            **/build/reports/lint-results-*.xml

      - name: Publish lint results
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: app/build/reports/lint-results-debug.sarif
        continue-on-error: true

  # ============================================================================
  # STEP 3: Build Debug APK
  # ============================================================================
  build-debug:
    name: "Build Debug APK"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: lint-strict
    
    strategy:
      matrix:
        variant: [normal, fdroid]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Debug APK (${{ matrix.variant }})
        run: ./gradlew assemble${{ matrix.variant == 'normal' && 'Normal' || 'Fdroid' }}Debug --no-daemon --stacktrace
        env:
          _JAVA_OPTIONS: "-Xmx4g"

      - name: Verify APK exists
        run: |
          find app/build/outputs/apk -name "*.apk" -type f
          test -f app/build/outputs/apk/${{ matrix.variant }}/debug/app-${{ matrix.variant }}-debug.apk || \
          test -f app/build/outputs/apk/${{ matrix.variant }}/debug/BoomingMusic-${{ matrix.variant }}-debug.apk

      - name: Upload Debug APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.variant }}-debug
          path: |
            app/build/outputs/apk/${{ matrix.variant }}/debug/*.apk
          retention-days: 14

      - name: Upload mapping files
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mapping-${{ matrix.variant }}-debug
          path: |
            app/build/outputs/mapping/**
          retention-days: 7

  # ============================================================================
  # STEP 4: Code Quality Checks
  # ============================================================================
  code-quality:
    name: "Code Quality"
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: kotlin-compile-check
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'
          cache: gradle

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Check dependency vulnerabilities
        run: ./gradlew dependencyUpdates --no-daemon
        continue-on-error: true

      - name: Generate project report
        run: ./gradlew projectReport --no-daemon
        continue-on-error: true

  # ============================================================================
  # STEP 5: Build Release (Unsigned)
  # ============================================================================
  build-release:
    name: "Build Release (Unsigned)"
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [lint-strict, build-debug]
    
    strategy:
      matrix:
        variant: [normal, fdroid]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: 'zulu'
          cache: gradle

      - name: Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build Release APK (${{ matrix.variant }})
        run: ./gradlew assemble${{ matrix.variant == 'normal' && 'Normal' || 'Fdroid' }}Release --no-daemon --stacktrace
        env:
          _JAVA_OPTIONS: "-Xmx4g"

      - name: Verify APK exists
        run: |
          find app/build/outputs/apk -name "*-release*.apk" -type f || true

      - name: Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: apk-${{ matrix.variant }}-release-unsigned
          path: |
            app/build/outputs/apk/${{ matrix.variant }}/release/*-release-unsigned.apk
            app/build/outputs/apk/${{ matrix.variant }}/release/*-release.apk
          retention-days: 14

  # ============================================================================
  # FINAL: Summary
  # ============================================================================
  quality-gate-summary:
    name: "Quality Gate Summary"
    runs-on: ubuntu-latest
    needs: [kotlin-compile-check, lint-strict, build-debug, code-quality, build-release]
    if: always()
    
    steps:
      - name: Check job statuses
        run: |
          echo "## Quality Gate Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Kotlin Compilation | ${{ needs.kotlin-compile-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Strict Lint | ${{ needs.lint-strict.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Debug | ${{ needs.build-debug.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Release | ${{ needs.build-release.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.kotlin-compile-check.result }}" != "success" ] || \
             [ "${{ needs.lint-strict.result }}" != "success" ] || \
             [ "${{ needs.build-debug.result }}" != "success" ]; then
            echo "❌ **Quality Gate FAILED**" >> $GITHUB_STEP_SUMMARY
            exit 1
          else
            echo "✅ **Quality Gate PASSED**" >> $GITHUB_STEP_SUMMARY
          fi
